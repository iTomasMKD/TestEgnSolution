using System.Collections.Generic;
using System.Linq;
using System;

namespace EgnApp.Repository
{
    public class EgnModuleRepository
    {
        public static object egn_regions = new Dictionary<object, object> {
            {
                43,
                new Dictionary<object, object> {
                    {
                        "bg",
                        "Благоевград"},
                    {
                        "en",
                        "Blagoevgrad"},
                    {
                        "start",
                        0},
                    {
                        "iso",
                        "BG-01"}}},
            {
                93,
                new Dictionary<object, object> {
                    {
                        "bg",
                        "Бургас"},
                    {
                        "en",
                        "Burgas"},
                    {
                        "start",
                        44},
                    {
                        "iso",
                        "BG-02"}}},
            {
                139,
                new Dictionary<object, object> {
                    {
                        "bg",
                        "Варна"},
                    {
                        "en",
                        "Varna"},
                    {
                        "start",
                        94},
                    {
                        "iso",
                        "BG-03"}}},
            {
                169,
                new Dictionary<object, object> {
                    {
                        "bg",
                        "Велико Търново"},
                    {
                        "en",
                        "Veliko Turnovo"},
                    {
                        "start",
                        140},
                    {
                        "iso",
                        "BG-04"}}},
            {
                183,
                new Dictionary<object, object> {
                    {
                        "bg",
                        "Видин"},
                    {
                        "en",
                        "Vidin"},
                    {
                        "start",
                        170},
                    {
                        "iso",
                        "BG-05"}}},
            {
                217,
                new Dictionary<object, object> {
                    {
                        "bg",
                        "Враца"},
                    {
                        "en",
                        "Vratza"},
                    {
                        "start",
                        184},
                    {
                        "iso",
                        "BG-06"}}},
            {
                233,
                new Dictionary<object, object> {
                    {
                        "bg",
                        "Габрово"},
                    {
                        "en",
                        "Gabrovo"},
                    {
                        "start",
                        218},
                    {
                        "iso",
                        "BG-07"}}},
            {
                281,
                new Dictionary<object, object> {
                    {
                        "bg",
                        "Кърджали"},
                    {
                        "en",
                        "Kurdzhali"},
                    {
                        "start",
                        234},
                    {
                        "iso",
                        "BG-09"}}},
            {
                301,
                new Dictionary<object, object> {
                    {
                        "bg",
                        "Кюстендил"},
                    {
                        "en",
                        "Kyustendil"},
                    {
                        "start",
                        282},
                    {
                        "iso",
                        "BG-10"}}},
            {
                319,
                new Dictionary<object, object> {
                    {
                        "bg",
                        "Ловеч"},
                    {
                        "en",
                        "Lovech"},
                    {
                        "start",
                        302},
                    {
                        "iso",
                        "BG-11"}}},
            {
                341,
                new Dictionary<object, object> {
                    {
                        "bg",
                        "Монтана"},
                    {
                        "en",
                        "Montana"},
                    {
                        "start",
                        320},
                    {
                        "iso",
                        "BG-12"}}},
            {
                377,
                new Dictionary<object, object> {
                    {
                        "bg",
                        "Пазарджик"},
                    {
                        "en",
                        "Pazardzhik"},
                    {
                        "start",
                        342},
                    {
                        "iso",
                        "BG-13"}}},
            {
                395,
                new Dictionary<object, object> {
                    {
                        "bg",
                        "Перник"},
                    {
                        "en",
                        "Pernik"},
                    {
                        "start",
                        378},
                    {
                        "iso",
                        "BG-14"}}},
            {
                435,
                new Dictionary<object, object> {
                    {
                        "bg",
                        "Плевен"},
                    {
                        "en",
                        "Pleven"},
                    {
                        "start",
                        396},
                    {
                        "iso",
                        "BG-15"}}},
            {
                501,
                new Dictionary<object, object> {
                    {
                        "bg",
                        "Пловдив"},
                    {
                        "en",
                        "Plovdiv"},
                    {
                        "start",
                        436},
                    {
                        "iso",
                        "BG-16"}}},
            {
                527,
                new Dictionary<object, object> {
                    {
                        "bg",
                        "Разград"},
                    {
                        "en",
                        "Razgrad"},
                    {
                        "start",
                        502},
                    {
                        "iso",
                        "BG-17"}}},
            {
                555,
                new Dictionary<object, object> {
                    {
                        "bg",
                        "Русе"},
                    {
                        "en",
                        "Ruse"},
                    {
                        "start",
                        528},
                    {
                        "iso",
                        "BG-18"}}},
            {
                575,
                new Dictionary<object, object> {
                    {
                        "bg",
                        "Силистра"},
                    {
                        "en",
                        "Silistra"},
                    {
                        "start",
                        556},
                    {
                        "iso",
                        "BG-19"}}},
            {
                601,
                new Dictionary<object, object> {
                    {
                        "bg",
                        "Сливен"},
                    {
                        "en",
                        "Sliven"},
                    {
                        "start",
                        576},
                    {
                        "iso",
                        "BG-20"}}},
            {
                623,
                new Dictionary<object, object> {
                    {
                        "bg",
                        "Смолян"},
                    {
                        "en",
                        "Smolyan"},
                    {
                        "start",
                        602},
                    {
                        "iso",
                        "BG-21"}}},
            {
                721,
                new Dictionary<object, object> {
                    {
                        "bg",
                        "София"},
                    {
                        "en",
                        "Sofia"},
                    {
                        "start",
                        624},
                    {
                        "iso",
                        "BG-22"}}},
            {
                751,
                new Dictionary<object, object> {
                    {
                        "bg",
                        "София (окръг)"},
                    {
                        "en",
                        "Sofia (county)"},
                    {
                        "start",
                        722},
                    {
                        "iso",
                        "BG-23"}}},
            {
                789,
                new Dictionary<object, object> {
                    {
                        "bg",
                        "Стара Загора"},
                    {
                        "en",
                        "Stara Zagora"},
                    {
                        "start",
                        752},
                    {
                        "iso",
                        "BG-24"}}},
            {
                821,
                new Dictionary<object, object> {
                    {
                        "bg",
                        "Добрич"},
                    {
                        "en",
                        "Dobrich"},
                    {
                        "start",
                        790},
                    {
                        "iso",
                        "BG-08"}}},
            {
                843,
                new Dictionary<object, object> {
                    {
                        "bg",
                        "Търговище"},
                    {
                        "en",
                        "Targovishte"},
                    {
                        "start",
                        822},
                    {
                        "iso",
                        "BG-25"}}},
            {
                871,
                new Dictionary<object, object> {
                    {
                        "bg",
                        "Хасково"},
                    {
                        "en",
                        "Haskovo"},
                    {
                        "start",
                        844},
                    {
                        "iso",
                        "BG-26"}}},
            {
                903,
                new Dictionary<object, object> {
                    {
                        "bg",
                        "Шумен"},
                    {
                        "en",
                        "Shumen"},
                    {
                        "start",
                        872},
                    {
                        "iso",
                        "BG-27"}}},
            {
                925,
                new Dictionary<object, object> {
                    {
                        "bg",
                        "Ямбол"},
                    {
                        "en",
                        "Yambol"},
                    {
                        "start",
                        904},
                    {
                        "iso",
                        "BG-28"}}},
            {
                999,
                new Dictionary<object, object> {
                    {
                        "bg",
                        "Друг"},
                    {
                        "en",
                        "Other"},
                    {
                        "start",
                        926},
                    {
                        "iso",
                        "BG-XX"}}}};

        // 
        //     Generate a random EGN.
        //     
        public static object generate_random(object gender = null, object region = null, object limit = 10)
        {
            object rand_region;
            var egns = new List<object>();
            while (egns.Count < limit)
            {
                if (region == null)
                {
                    var rr = random.randint(1, 28);
                    rand_region = "BG-{rr:02d}";
                }
                else
                {
                    rand_region = region;
                }
                var year = random.randint(1800, datetime.today().year - 1);
                var month = random.randint(1, 12);
                var day = random.randint(1, 28);
                var date_from = "{year}-{month}-{day}";
                var date_to = datetime.today().strftime("%Y-%m-%d");
                var rand_egn = generate(date_from: date_from, date_to: date_to, region: rand_region, gender: gender, limit: 1);
                if (rand_egn.Count == 1)
                {
                    egns.append(rand_egn[0]);
                }
            }
            return egns;
        }
  
        public static object generate(
            object date_from = "1800-01-01",
            object date_to = datetime.today().strftime("%Y-%m-%d"),
            object gender = null,
            object region = null,
            object limit = 10)
        {
            object regions;
            Func<object, object> get_region_range = region => {
                var start = 0;
                var end = 0;
                foreach (var i in egn_regions)
                {
                    if (new List<object> {
                        egn_regions[i]["en"].lower(),
                        egn_regions[i]["bg"].lower(),
                        egn_regions[i]["iso"].lower()
                    }.Contains(region.lower()))
                    {
                        start = egn_regions[i]["start"];
                        end = i;
                    }
                }
                return Tuple.Create(start, end);
            };
            Func<object, object, object, object> get_dates_range = (date_from, date_to, limit) => {
                var dates = new List<object>();
                try
                {
                    var sdate = datetime.strptime(date_from, "%Y-%m-%d");
                    var edate = datetime.strptime(date_to, "%Y-%m-%d");
                    var delta = edate - sdate;
                    foreach (var i in Enumerable.Range(0, delta.days + 1))
                    {
                        if (limit != null && i > limit)
                        {
                            return dates;
                        }
                        var dday = (sdate + timedelta(days: i)).ToString();
                        var year = Convert.ToInt32(dday[0::4]);
                        var month = Convert.ToInt32(dday[6::7]);
                        var day = Convert.ToInt32(dday[8::10]);
                        if (year >= 2000)
                        {
                            month += 40;
                            year -= 2000;
                        }
                        else if (year < 1900)
                        {
                            month += 20;
                            year -= 1800;
                        }
                        else
                        {
                            // Gregorian calendar adoption: 31/03/1916 > +13 days > 14/04/1916
                            if (year == 1916 && month == 4 && day <= 13)
                            {
                                continue;
                            }
                            year -= 1900;
                        }
                        dates.append("{year:02d}{month:02d}{day:02d}");
                    }
                    return dates;
                }
                catch (Exception)
                {
                    Console.WriteLine(e);
                    return null;
                }
            };
            var egns = new List<object>();
            if (!region)
            {
                regions = Enumerable.Range(0, Convert.ToInt32(Math.Ceiling(Convert.ToDouble(999 - 0) / 1))).Select(_x_1 => 0 + _x_1 * 1);
            }
            else
            {
                var _tup_1 = get_region_range(region);
                var region_start = _tup_1.Item1;
                var region_end = _tup_1.Item2;
                regions = Enumerable.Range(0, Convert.ToInt32(Math.Ceiling(Convert.ToDouble(region_end - region_start) / 1))).Select(_x_2 => region_start + _x_2 * 1);
            }
            if (gender != null)
            {
                if (gender[0].lower() == "m")
                {
                    // Male
                    regions = (from x in regions
                               where x % 2 == 0
                               select x).ToList();
                }
                else
                {
                    // Female
                    regions = (from x in regions
                               where x % 2
                               select x).ToList();
                }
            }
            regions = (from x in regions
                       select "{x:02d}").ToList();
            var dates = get_dates_range(date_from, date_to, limit: limit);
            var counter = 1;
            // Generate the list of egns
            foreach (var dt in dates)
            {
                foreach (var region in regions)
                {
                    foreach (var check_num in Enumerable.Range(0, Convert.ToInt32(Math.Ceiling(Convert.ToDouble(9 - 0) / 1))).Select(_x_3 => 0 + _x_3 * 1))
                    {
                        var egene = "{dt}{region}{check_num}";
                        if (validate(egene))
                        {
                            counter += 1;
                            egns.append(egene);
                            if (counter > limit)
                            {
                                return egns;
                            }
                        }
                    }
                }
            }
            return egns;
        }

        public static object get_date(object egn)
        {
            try
            {
                var year = Convert.ToInt32(egn[0::2]);
                var month = Convert.ToInt32(egn[2::4]);
                var day = Convert.ToInt32(egn[4::6]);
            }
            catch (Exception)
            {
                return false;
            }
            if (month >= 40)
            {
                month -= 40;
                year += 2000;
            }
            else if (month >= 20)
            {
                month -= 20;
                year += 1800;
            }
            else
            {
                year += 1900;
            }
            try
            {
                var dt = datetime.strptime(String.Format("%s-%s-%s", year, month, day), "%Y-%m-%d");
                return new Dictionary<object, object> {
                    {
                        "year",
                        year},
                    {
                        "month",
                        month},
                    {
                        "day",
                        day},
                    {
                        "datetime",
                        dt}};
            }
            catch (ValueError)
            {
                return false;
            }
        }

        public static object validate(object egn)
        {
            if (egn is int)
            {
                egn = "{0:0=10d}".format(egn).ToString();
            }
            Func<object, object> check_valid_code = egn => {
                var egn_weights = (2, 4, 8, 5, 10, 9, 7, 3, 6);
                try
                {
                    var my_sum = (from _tup_1 in zip(egn_weights, egn).Chop((weight, digit) => (weight, digit))
                                  let weight = _tup_1.Item1
                                  let digit = _tup_1.Item2
                                  select (weight * Convert.ToInt32(digit))).ToList().Sum();
                    return Convert.ToInt32(egn[-1]) == my_sum % 11 % 10;
                }
                catch (ValueError)
                {
                    return false;
                }
            };
            Func<object, object> check_greg_adopt = egn_date => {
                // Gregorian calendar adoption: 31/03/1916 > +13 days > 14/04/1916
                if (egn_date["year"] == 1916 && egn_date["month"] == 4 && egn_date["day"] <= 13)
                {
                    return false;
                }
                return true;
            };
            var egn_date = get_date(egn);
            return egn.Count == 10 && check_valid_code(egn) && egn_date is dict && check_greg_adopt(egn_date);
        }

        public static object parse(object egn)
        {
            egn = egn.ToString();
            if (!validate(egn))
            {
                throw Exception("Invalid EGN");
            }
            var egn_hash = new Dictionary<object, object>
            {
            };
            // Parse the date
            egn_hash.update(get_date(egn));
            // Parse the region
            var region_num = Convert.ToInt32(egn[6::9]);
            var sorted_regions = egn_regions.items().OrderBy(_p_1 => _p_1).ToList();
            foreach (var _tup_1 in sorted_regions)
            {
                var key = _tup_1.Item1;
                var value = _tup_1.Item2;
                if (key > region_num)
                {
                    egn_hash["region_bg"] = value["bg"];
                    egn_hash["region_en"] = value["en"];
                    egn_hash["region_iso"] = value["iso"];
                    break;
                }
            }
            // Parse the gender
            egn_hash["gender"] = "Male";
            if (Convert.ToInt32(egn[8::9]) % 2)
            {
                egn_hash["gender"] = "Female";
            }
            egn_hash["egn"] = egn;
            return egn_hash;
        }

        public static object parse_args(object args)
        {
            var parser = argparse.ArgumentParser();
            var today = format(datetime.today().strftime("%Y-%m-%d"));
            parser.add_argument("-v", "--validate", help: "Validate EGN", type: str);
            parser.add_argument("-p", "--parse", help: "Parse EGN", type: str);
            // Generation
            parser.add_argument("-l", "--limit", help: "Limit of generated results (default: 1)", type: @int, @default: 1);
            parser.add_argument("-r", "--random", help: "Generate random EGN (default limit: 1)", action: "store_true");
            parser.add_argument("-g", "--generate", help: "Generate EGN", action: "store_true");
            parser.add_argument("--gender", help: "Gender - Male or Female", type: str, choices: new List<object> {
                "m",
                "f"
            });
            parser.add_argument("--region", help: "Region (Latin/Cyrrilic region name or ISO 3166 format)", type: str);
            parser.add_argument("--from", help: "Date from generate (Y-m-d) (default: 1800-01-01)", type: str, @default: "1800-01-01");
            parser.add_argument("--to", type: str, help: "Date to generate (Y-m-d) (default: {today})", @default: today);
            return vars(parser.parse_args(args));
        }

        // 
        //         Method to parse the argparse values and return an output.
        //     
        public static object calc_args(object parser)
        {
            object validate_egn;
            if (parser.Contains("parse") && parser["parse"])
            {
                validate_egn = parser["parse"].ToString();
                if (!validate(validate_egn))
                {
                    return ("{} is invalid!".format(validate_egn));
                    exit(1);
                }
                validate_egn = parse(validate_egn);
                validate_egn.pop("datetime");
                return (json.dumps(validate_egn));
            }
            else if (parser.Contains("random") && parser["random"])
            {
                 return ("\n".join(generate_random(limit: parser["limit"], region: parser["region"], gender: parser["gender"])));
            }
            else if (parser.Contains("generate") && parser["generate"])
            {
                return("\n".join(generate(limit: parser["limit"], region: parser["region"], gender: parser["gender"], date_from: parser["from"], date_to: parser["to"])));
            }
            else if (parser.Contains("validate") && parser["validate"])
            {
                validate_egn = parser["validate"].ToString();
                if (validate(validate_egn))
                {
                    return ("{} is valid!".format(validate_egn));
                }
                else
                {
                    return ("{} is invalid!".format(validate_egn));
                    exit(1);
                }
            }
            else
            {
                parse_args(new HashSet({
                    "-h"}));
            }
        }   
    }
}
